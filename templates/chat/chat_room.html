{% extends "base.html" %}
{% block title %}{{ room.name }} - Chat{% endblock %}

{% block content %}
<h1 class="mb-4">{{ room.name }}</h1>

<div id="chat-messages" class="mb-3" style="height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">
    {% for message in messages %}
        <div>
            <strong>{{ message.sender.username }}</strong>: {{ message.content }}
            <small class="text-muted">{{ message.timestamp|date:"Y-m-d H:i" }}</small>
        </div>
    {% endfor %}
</div>

<form id="send-message-form">
    {% csrf_token %}
    <div class="input-group">
        <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
        <button type="submit" class="btn btn-success">Send</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const sendMessageForm = document.getElementById('send-message-form');
    const messageInput = document.getElementById('message-input');
    const roomId = "{{ room.id }}";

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    scrollToBottom();

    sendMessageForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            fetch(`/chat/send/${roomId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `content=${encodeURIComponent(message)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    messageInput.value = '';
                }
            });
        }
    });

    function getMessages() {
        fetch(`/chat/messages/${roomId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                chatMessages.innerHTML = '';
                data.messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.innerHTML = `
                        <strong>${message.sender}</strong>: ${message.content}
                        <small class="text-muted">${new Date(message.timestamp).toLocaleString()}</small>
                    `;
                    chatMessages.appendChild(messageElement);
                });
                scrollToBottom();
            }
        });
    }

    setInterval(getMessages, 2000);
});
</script>
{% endblock %}
